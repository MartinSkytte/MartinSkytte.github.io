<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Data of Denmark - How do we live</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" >
        <link rel="stylesheet" href="css/style.css">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->    
    </head>
    <body>
        <div class="container">
            <h1>Hello, world!</h1>

            <div style="dod">
                <!--[if IE 6]>
                    <div id="dod-error">
                    <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                    <div id="dod-mapFrame" style="display:none;">
                <![endif]-->
                <!--[if IE 7]>
                    <div id="dod-error">
                    <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                    <div id="dod-mapFrame" style="display:none;">
                <![endif]-->
                <!--[if IE 8]>
                    <div id="dod-error">
                    <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                    <div id="dod-mapFrame" style="display:none;">
                <![endif]-->
                <!--[if IE 9]>
                    <div id="dod-mapFrame">
                <![endif]-->  
                <![if !IE]><div id="dod-mapFrame"><![endif]>
                    <span id="loading" class="glyphicon glyphicon-refresh">Loading... data</span>
                    <div id="dod-chart">
                        <div id="dod-tooltip">
                            <div id="dod-tooltipContainer">
                                <div class="dod-name"></div>
                                <div class="dod-code"></div>
                                <div class="dod-tail"></div>
                            </div>
                        </div>
                        <div id="dod-mapCanvas"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <!-- Include the d3 lib so we can make cool graphs -->
        <script src="js/d3.min.js"></script>

        <script type='text/javascript'>
            jQuery.noConflict();
            var $j = jQuery;
            var dod = dod || {};
            /************************
             ** Map functions
             ***********************/
            dod.Map = function () {
                return {
                    $j: jQuery,
                    width: 970,
                    height: 850,
                    svg: {},
                    nameFormat: function (n) {
                        return "County code: " + n;
                    },
                    mapProjection: d3.geo.conicConformal().scale(10300).center([11, 56.3]),
                    mapPath: {},
                    mapCountour: {},
                    municipality_arry: [],
                    municipality_data_arry: [],
                    current_year: "2010",
                    years: ["2010", "2013"],
                    maxValueForYear: function (year) {
                        var that = this;
                        return d3.max(this.municipality_arry, function (data) {
                            if ("" + year === that.current_year) {

                                return data.count;
                            }
                            return 0;
                        });
                    },
                    init: function () {
                        var that = this;
                        this.svg = d3.select("#dod-mapCanvas")
                                .append("svg:svg")
                                .attr("width", that.width)
                                .call(d3.behavior.zoom()
                                        .on("zoom", function () {
                                            that.zoomMap();
                                        }));

                        this.mapPath = d3.geo.path().projection(this.mapProjection);

                        this.mapCountour = this.svg
                                .append("g")
                                .attr("id", "mapCountour");

                        d3.json('js/kommune.json', function (data) {
                            that.municipality_arry = data;
                        });

                        d3.json('js/data.json', function (data) {
                            that.municipality_data_arry = data;
                            $j("#loading").hide();
                        });

                        //Load in GeoJSON data
                        d3.json("js/kommuner.geojson", function (json) {

                            console.log(that);

                            //Bind data and create one path per GeoJSON feature
                            that.mapCountour.selectAll("path")
                                    .data(json.features)
                                    .enter()
                                    .append("path")
                                    .attr("d", that.mapPath)
                                    .attr("stroke", "black")
                                    .style("fill", "steelblue")
                                    .on('mouseover', function (d) {
                                        var el = d3.select(this);
                                        var bBox = that.tooltipPosition(el);
                                        var xpos = Number(bBox[0]);
                                        var ypos = (bBox[1] - 10);

                                        el.style("stroke", "#000")
                                                .style("stroke-width", 3);

                                        d3.select("#dod-tooltip")
                                                .style('top', ypos + "px")
                                                .style('left', xpos + "px")
                                                .style('display', 'block');

                                        d3.select(".dod-name")
                                                .html(d.properties.KOMNAVN);

                                        d3.select(".dod-code")
                                                .html(that.nameFormat(d.properties.KOMKODE));

                                    })
                                    .on('mouseout', function () {
                                        d3.select(this)
                                                .style("stroke-width", 1);
                                        d3.select("#dod-tooltip")
                                                .style('display', 'none');
                                    });
                        });
                    },
                    zoomMap: function () {
                        this.mapCountour.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                    },
                    tooltipPosition: function (element) {
                        var bbox = element.node().getBBox();
                        return [bbox.x + bbox.width / 2, bbox.y - 10 + bbox.height / 2];
                    }
                };
            };

            dod.Data = function () {
                return {
                    municipality_arry: [],
                    municipality_data_arry: [],
                    init: function () {
                        var that = this;

                    }
                };
            };

            dod.ready = function () {
                dod.m = new dod.Map();
                dod.m.init();
            };
            if (!!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect) {
                $j(document).ready($j.proxy(dod.ready, this));
            } else {
                $j("#dod-mapFrame").hide();
            }
        </script>
    </body>
</html>