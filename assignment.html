<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Data of Denmark - How do we live</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" >
        <link rel="stylesheet" href="css/style.css">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->    
    </head>
    <body>
        <div class="container">
            <h1>Data of Denmark</h1>
            <div class="row">
                <div class="text-center col-sm-offset-2 col-sm-8">
                    <div class="btn-group center-block" role="group" id="charts">

                    </div>
                </div>
                <div class="col-xs-12">
                    <div style="dod">
                        <!--[if IE 6]>
                            <div id="dod-error">
                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                            <div id="dod-mapFrame" style="display:none;">
                        <![endif]-->
                        <!--[if IE 7]>
                            <div id="dod-error">
                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                            <div id="dod-mapFrame" style="display:none;">
                        <![endif]-->
                        <!--[if IE 8]>
                            <div id="dod-error">
                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                            <div id="dod-mapFrame" style="display:none;">
                        <![endif]-->
                        <!--[if IE 9]>
                            <div id="dod-mapFrame">
                        <![endif]-->  
                        <![if !IE]><div id="dod-mapFrame"><![endif]>
                            <span id="loading" class="glyphicon glyphicon-refresh">Loading... data</span>
                            <div id="dod-chart">


                                <!--<div id="dod-tooltip">
                                    <div id="dod-tooltipContainer">
                                        <div class="dod-name"></div>
                                        <div class="dod-code"></div>
                                    </div>
                                </div>-->
                                <div id="dod-canvas">
                                    <div id="dod-map-explanation">
                                        <h4 id="showing-year"></h4>
                                        <p id="dod-map-explanation-txt"></p>
                                    </div>
                                    <div id="dod-map-facts">

                                    </div>
                                    <div id="dod-tooltip" class="panel panel-default">
                                        <div class="panel-heading">
                                            <h3 class="panel-title dod-name"></h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="xs-col-6 text-uppercase text-bold">Approximated number of Children</div>
                                            <div id="dod-children" class="xs-col-6"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center col-sm-offset-4 col-sm-4">
                    <div class="btn-group center-block" role="group" id="years">

                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <!-- Include the d3 lib so we can make cool graphs -->
        <script src="js/d3.min.js"></script>

        <script type='text/javascript'>
            jQuery.noConflict();
            var $j = jQuery;
            var dod = dod || {};
            /************************
             ** Map functions
             ***********************/
            dod.Chart = function () {
                return {
                    $j: jQuery,
                    width: 970,
                    height: 850,
                    centerX: 0,
                    centerY: 0,
                    svg: {},
                    mapProjection: d3.geo.conicConformal().scale(10300).center([11, 56.3]),
                    mapFeatures: [],
                    mapPath: {},
                    mapCountour: {},
                    totalChildren: 0,
                    municipality_array: [],
                    municipality_data_array: [],
                    wc_bath_types: {"1": "Toilet in dwelling & Bathroom in dwelling", "2": "Toilet in dwelling or Bathroom in dwelling", "3": "Toilet outside dwelling or Access to bathroom", "4": "Other/no toilet or No bathroom or access to bathroom"},
                    housing_types: {"1": "Detached houses/farmhouses", "2": "Terraced, linked or semi-detached houses", "3": "Multi-dwelling houses"},
                    data_bobbles: [],
                    current_data: [],
                    current_year: "2013",
                    years: ["2013", "2014", "2015"],
                    charts: [{"chart": "map", "name": "Country Distribution"}, {"chart": "bobble", "name": "All Sanatories"}, {"chart": "circle", "name": "Type of Sanatory"}, {"chart": "totals", "name": "Totals by Municipality"}],
                    mapExplainTxt: "The map is showing displaying some basic data for each municipality when hovering over them. You can also zoom or drag the map to find the data of the municipality you want.\n\
                                    <br/><br/> When saying approximated, it is because the families is divinded into groups. They are as follows: <ul><li>0 Children</li><li>1 Child</li><li>2 Children</li><li>3 Children</li><li>4 Children</li><li>5 or Above Children</li></ul>",
                    maxValueForYear: function (year) {
                        var that = this;
                        return d3.max(this.municipality_array, function (data) {
                            if ("" + year === that.current_year) {
                                return data.Count;
                            }
                            return 0;
                        });
                    },
                    rScale: function (n) {
                        var that = this;
                        var scale = d3.scale.pow().exponent(.5).domain([0, that.maxValueForYear(that.current_year)]).range([1, 90]);
                        return scale(n);
                    },
                    init: function () {
                        var that = this;
                        d3.select('#showing-year').html("Showing data for year " + this.current_year);
                        this.svg = d3.select("#dod-canvas")
                                .append("svg:svg")
                                .attr("width", that.width)
                                .call(d3.behavior.zoom()
                                        .on("zoom", function () {
                                            that.zoomMap();
                                        }));

                        this.mapPath = d3.geo.path().projection(this.mapProjection);

                        this.centerX = this.width / 2;
                        this.centerY = this.height / 2;

                        this.mapCountour = this.svg
                                .append("g")
                                .attr("id", "mapCountour");

                        this.loadMunicipality();

                    },
                    loadMunicipality: function () {
                        var that = this;
                        dod.setupButtons();
                        d3.json('js/IkkeOpdelt.json', function (data) {
                            that.municipality_array = data;
                            that.loadData();
                        });
                    },
                    loadData: function () {
                        var that = this;

                        d3.json('js/Opdelt.json', function (data) {
                            that.municipality_data_array = data;
                            that.generateDataArray();
                            that.loadGeo();
                        });
                    },
                    loadGeo: function () {
                        var that = this;
                        //Load in GeoJSON data
                        d3.json("js/kommuner.geojson", function (json) {
                            that.mapFeatures = json.features;
                            that.setupMap();

                            that.$j("#loading").hide();

                            console.log(that.rScale(300000));
                            console.log(that);
                        });
                    },
                    setupMap: function () {
                        var that = this;

                        //setup the totals facts
                        this.$j("#dod-map-explanation-txt").html(this.mapExplainTxt);
                        this.generateMapTotals();


                        //Bind data and create one path per GeoJSON feature
                        this.mapCountour.selectAll("path")
                                .data(that.mapFeatures)
                                .enter()
                                .append("path")
                                .attr("d", that.mapPath)
                                .attr("stroke", "black")
                                .style("fill", "steelblue")
                                .on('mouseover', function (d) {
                                    var el = d3.select(this);
                                    var bBox = that.tooltipPosition(el);
                                    var xpos = Number(bBox[0]);
                                    var ypos = (bBox[1] - 10);
                                    var data = that.getInfo(d.properties.KOMKODE);

                                    el.style("stroke", "#000")
                                            .style("stroke-width", 3);

                                    d3.select("#dod-tooltip")
                                            .style('display', 'block');

                                    d3.select(".dod-name")
                                            .html(data['District'] + " " + data['District Code']);

                                    d3.select("#dod-children")
                                            .html(that.getChildrenForCode(d.properties.KOMKODE).toLocaleString('en-US'));

                                })
                                .on('mouseout', function () {
                                    d3.select(this)
                                            .style("stroke-width", 1);
                                    d3.select("#dod-tooltip")
                                            .style('display', 'none');
                                });
                    },
                    generateMapTotals: function () {
                        var totalData = this.getInfoData();
                        var children = 0;
                        var childrenByHouseType = {};
                        var div = this.$j("#dod-map-facts");


                        for (var i = 0; i < totalData.length; i++) {

                            if (childrenByHouseType.hasOwnProperty(totalData[i]['Housing'])) {
                                childrenByHouseType[totalData[i]['Housing']] += totalData[i]['approx'];
                            } else {
                                childrenByHouseType[totalData[i]['Housing']] = totalData[i]['approx'];
                            }
                            children += totalData[i]['approx'];
                        }

                        this.totalChildren = children;

                        div.html('<h4>The approx. number of children per house type</h4>'
                                + '<h5>' + this.housing_types[1] + '</h5>'
                                + childrenByHouseType[1].toLocaleString('en-US')
                                + '<h5>' + this.housing_types[2] + '</h5>'
                                + childrenByHouseType[2].toLocaleString('en-US')
                                + '<h5>' + this.housing_types[3] + '</h5>'
                                + childrenByHouseType[3].toLocaleString('en-US')
                                + '<h5>Total</h5>'
                                + children.toLocaleString('en-US')
                                );
                    },
                    zoomMap: function () {
                        this.mapCountour.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                    },
                    tooltipPosition: function (element) {
                        var bbox = element.node().getBBox();
                        return [bbox.x + bbox.width / 2, bbox.y - 10 + bbox.height / 2];
                    },
                    generateDataArray: function () {
                        this.current_data = [];
                        for (var i = 0; i < this.municipality_data_array.length; i++) {
                            if ("" + this.municipality_data_array[i]['Year'] === "" + this.current_year) {
                                this.current_data.push(this.municipality_data_array[i]);
                            }
                        }

                        this.generateMapTotals();
                    },
                    getChildrenForCode: function (code) {
                        var children = 0;
                        for (var i = 0; i < this.current_data.length; i++) {
                            if (this.current_data[i]['Year'] === this.current_year && "" + this.current_data[i]['District Code'] === "" + code) {
                                children += (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']);
                            }
                        }
                        return children;
                    },
                    getInfoData: function () {
                        var info = [];

                        for (var i = 0; i < this.current_data.length; i++) {
                            if (this.current_data[i]['Year'] === this.current_year) {
                                var infoIndex = info.findIndex(function (element) {
                                    return (this.WcBath === element.WcBath && this.Housing === element.Housing);
                                }, {"WcBath": this.current_data[i]['WcBath'], "Housing": this.current_data[i]['House type']});

                                if (infoIndex === -1) {
                                    var obj = {
                                        "Count": this.current_data[i]['Count'],
                                        "Housing": this.current_data[i]['House type'],
                                        "WcBath": this.current_data[i]['WcBath'],
                                        "approx": (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count'])
                                    };
                                    info.push(obj);
                                } else {
                                    var obj = info[infoIndex];
                                    obj['Count'] += this.current_data[i]['Count'];
                                    obj['approx'] += (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']);
                                    info[infoIndex] = obj;
                                }
                            }
                        }

                        return info;
                    },
                    getInfo: function (code) {
                        var data = [];

                        for (var i = 0; i < this.municipality_array.length; i++) {
                            if ("" + this.municipality_array[i]['District Code'] === "" + code && "" + this.current_year === "" + this.municipality_array[i]['Year']) {
                                data = this.municipality_array[i];
                                break;
                            }
                        }

                        return data;
                    },
                };
            };

            dod.setupButtons = function () {
                var that = this;
                for (var i = 0; i < dod.c.years.length; i++) {
                    d3.select("#years")
                            .insert('button')
                            .attr('type', 'button')
                            .attr('class', 'btn-year btn btn-default')
                            .attr('data-year', dod.c.years[i])
                            .html(dod.c.years[i])
                            .on('click', function () {
                                var year = d3.select(this).attr('data-year');
                                var activeClass = "active";
                                var alreadyIsActive = d3.select(this).classed(activeClass);

                                // set active year button
                                d3.selectAll(".btn-year")
                                        .classed(activeClass, false);
                                d3.select(this).classed(activeClass, !alreadyIsActive);

                                dod.c.current_year = year;
                                dod.c.generateDataArray();
                                d3.select('#showing-year').html("Showing data for year " + year);
                            });
                }

                d3.select("#charts")
                        .insert('button')
                        .attr('type', 'button')
                        .attr('class', 'btn-chart btn btn-default')
                        .attr('data-chart', dod.c.charts[0].chart)
                        .html(dod.c.charts[0].name)
                        .on('click', function () {
                            var year = d3.select(this).attr('data-chart');
                            var activeClass = "active";
                            var alreadyIsActive = d3.select(this).classed(activeClass);

                            // set active year button
                            d3.selectAll(".btn-chart")
                                    .classed(activeClass, false);
                            d3.select(this).classed(activeClass, !alreadyIsActive);
                        });

                d3.select("#charts")
                        .insert('button')
                        .attr('type', 'button')
                        .attr('class', 'btn-chart btn btn-default')
                        .attr('data-chart', dod.c.charts[1].chart)
                        .html(dod.c.charts[1].name)
                        .on('click', function () {
                            var year = d3.select(this).attr('data-chart');
                            var activeClass = "active";
                            var alreadyIsActive = d3.select(this).classed(activeClass);

                            // set active year button
                            d3.selectAll(".btn-chart")
                                    .classed(activeClass, false);
                            d3.select(this).classed(activeClass, !alreadyIsActive);
                        });

                d3.select("#charts")
                        .insert('button')
                        .attr('type', 'button')
                        .attr('class', 'btn-chart btn btn-default')
                        .attr('data-chart', dod.c.charts[2].chart)
                        .html(dod.c.charts[2].name)
                        .on('click', function () {
                            var year = d3.select(this).attr('data-chart');
                            var activeClass = "active";
                            var alreadyIsActive = d3.select(this).classed(activeClass);

                            // set active year button
                            d3.selectAll(".btn-chart")
                                    .classed(activeClass, false);
                            d3.select(this).classed(activeClass, !alreadyIsActive);
                        });

                d3.select("#charts")
                        .insert('button')
                        .attr('type', 'button')
                        .attr('class', 'btn-chart btn btn-default')
                        .attr('data-chart', dod.c.charts[3].chart)
                        .html(dod.c.charts[3].name)
                        .on('click', function () {
                            var year = d3.select(this).attr('data-chart');
                            var activeClass = "active";
                            var alreadyIsActive = d3.select(this).classed(activeClass);

                            // set active year button
                            d3.selectAll(".btn-chart")
                                    .classed(activeClass, false);
                            d3.select(this).classed(activeClass, !alreadyIsActive);
                        });

            };

            dod.ready = function () {
                dod.c = new dod.Chart();
                dod.c.init();
            };
            if (!!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect) {
                $j(document).ready($j.proxy(dod.ready, this));
            } else {
                $j("#dod-mapFrame").hide();
            }
        </script>
    </body>
</html>