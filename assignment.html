<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Data of Denmark - How do we live</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" >
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/bootstrap-magnify.min.css">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->    
    </head>
    <body id="page-top">
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand page-scroll" href="#page-top">The bath and toilet facilities of Denmark</a>
                </div>
                <div class="container">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a class="page-scroll" href="#why-data">Why this data?</a></li>
                            <li><a class="page-scroll" href="#know-data">Know the data</a></li>
                            <li><a class="page-scroll" href="#data-famalies">Families without toilet or bath</a></li>
                            <li><a class="page-scroll" href="#lack-data">What is missing toilet or bath?</a></li>
                            <li><a class="page-scroll" href="#machine-data">Learning from data</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        <div class="container-fluid">
            <h1>Bath & Toilet data of Danish homes</h1>
            <div class="row">
                <div class="col-xs-4" style="height:100%;">
                    <div id="why-data" class="panel panel-default" style="height:100%;">
                        <div class="panel-heading">Why this data and presentation</div>
                        <div class="panel-body">
                            <p>
                                We have found a data set containing the living conditions of families in Denmark. 
                                The data set i divided in districts, type of resident, type of dwelling, heating, toilet facilities, bath facilities, 
                                type of household and number of children through the years of 2010-2016
                            </p>
                            <p>
                                We have chosen to use this dataset because we both live in Denmark, and are intrigued that there might still be 
                                places in Denmark where children are living and they don't have access to either bath or toilet.
                            </p>
                            <p>
                                We want to show the progress of living standards in Denmark, and how it have changed through the years.
                            </p>
                            <p>
                                We have chosen to present the data through, an interactive graph with the main numbers for the whole country,
                                this is done because it gives a good overview over the numbers and explains the basics.
                            </p>
                            <p>
                                We have then made some interactive diagrams, where the main data is done with circles. This is done so the user easily can
                                get an overview of the main points of the dataset and see the relation through the size and keywords and metrics shown
                                at either side of the circle.
                            </p>
                            <p>
                                For showing the main categories of the dataset, there is a last interactive button that divides the data into the four main
                                categories. Again keeping the circles, this is done so the user easy can see the difference in sizes of the different 
                                numbers. But the grouping also gives great visual clues about the actual grouping so the different groups easily can be seen.
                            </p>
                            <p>
                                For the rest of the data it is shown, in classic graph with some explanatory text, for the people who want to know more about
                                how and why the data comes to live. This also shows the user some of the fun facts about the data.
                            </p>
                            <p>
                                You can get the underlying dataset here: <a class="btn btn-primary" target="_blank" href="#">Get the data</a> - 
                                <a class="btn btn-success" target="_blank" href="#">Get the data processing</a>
                            </p>
                            <div style="height:44px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-8">
                    <div id="know-data" class="panel panel-default">
                        <div class="panel-heading">Getting to know the data</div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="text-center col-sm-offset-3 col-sm-6">
                                    <div class="btn-group center-block" role="group" id="charts">

                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <div style="dod">
                                        <!--[if IE 6]>
                                            <div id="dod-error">
                                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                                            <div id="dod-mapFrame" style="display:none;">
                                        <![endif]-->
                                        <!--[if IE 7]>
                                            <div id="dod-error">
                                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                                            <div id="dod-mapFrame" style="display:none;">
                                        <![endif]-->
                                        <!--[if IE 8]>
                                            <div id="dod-error">
                                            <p>This interactive graphic requires a browser with SVG support, such as <a href="http://www.google.com/chrome">Chrome</a>, <a href="http://www.mozilla.org/en-US/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/download/">Safari</a> or the latest <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home">Internet Explorer 9</a>. </p>
                                            <div id="dod-mapFrame" style="display:none;">
                                        <![endif]-->
                                        <!--[if IE 9]>
                                            <div id="dod-mapFrame">
                                        <![endif]-->  
                                        <![if !IE]><div id="dod-mapFrame"><![endif]>
                                            <div id="loading" class="glyphicon glyphicon-refresh">
                                                Loading... data
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 0em;">
                                                        0%
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="dod-chart">
                                                <div id="dod-canvas">
                                                    <h4 id="showing-year"></h4>
                                                    <div id="dod-map-overlay">
                                                        <div id="dod-map-explanation">
                                                            <p id="dod-map-explanation-txt"></p>
                                                        </div>
                                                        <div id="dod-map-facts">

                                                        </div>
                                                        <div id="dod-map-tooltip" class="panel panel-default">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title dod-name"></h3>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="xs-col-6 text-uppercase text-bold">Approximated number of Children</div>
                                                                <div id="dod-children" class="xs-col-6"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="dod-total-overlay">
                                                        <div id="dod-nowcbath-explain">
                                                            The number of children, that either don't have a toilet and/or a bath, or even access to them in some cases is approx. <strong id="dod-nowcbath-total"></strong> see size below
                                                        </div>
                                                        <svg id="dod-nowcbath"></svg>
                                                        <h5 id="dod-size-heading">The size of the circles indicates approx number of children</h5>
                                                        <div id="dod-sizeKey">
                                                            <div style="left:82px;top:10px;width:20px;" class="dod-circleKeyLabel"><span style="left:25px;">100,000</span></div>
                                                            <div style="left:62px;top:72px;" class="dod-circleKeyLabel"><span>1,000</span></div>
                                                            <div style="left:62px;top:87px;" class="dod-circleKeyLabel"><span>100</span></div>
                                                            <svg id="dod-scaleKey"></svg>
                                                        </div>
                                                    </div>
                                                    <div id="dod-split-overlay">
                                                        <div class="explain-txt"><h4>Getting a bath or using the toilet</h4>All the numbers mean, that <strong id="dod-percent-children"></strong>% of the children in Denmark does not have directly access to a toilet or a bath.</div>
                                                        <div id="dod-lbl-wcbath" class="lbl-absolute"></div>
                                                        <div id="dod-lbl-wcorbath" class="lbl-absolute"></div>
                                                        <div id="dod-lbl-nowcorbath" class="lbl-absolute"></div>
                                                        <div id="dod-lbl-nowcandbath" class="lbl-absolute"></div>
                                                    </div>
                                                </div>
                                                <div id="dod-graph-tooltip" class="panel panel-default">
                                                    <div class="panel-heading">
                                                        <h3 class="panel-title dod-graph-name"></h3>
                                                    </div>
                                                    <div class="panel-body">
                                                        <div class="text-uppercase text-bold">Type of Housing</div>
                                                        <div id="dod-graph-house"></div>
                                                        <div class="text-uppercase text-bold">Type of WC/Bath</div>
                                                        <div id="dod-graph-wcbath"></div>
                                                        <div class="text-uppercase text-bold">Approx. Number of Children</div>
                                                        <div id="dod-graph-children"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="text-center col-sm-offset-4 col-sm-4">
                                    <div class="btn-group center-block" role="group" id="years">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="data-famalies" class="col-xs-12">
            <div class="panel panel-default">
                <div class="panel-heading">What are the families living without? Baths? or Toilets?</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-6 no-padding">
                            <img src="img/houses-bath-families.jpg" data-toggle="magnify" class="img-responsive center-block">
                        </div>
                        <div class="col-xs-6 no-padding">
                            <img src="img/houses-toi-families.jpg" data-toggle="magnify" class="img-responsive center-block">
                        </div>
                        <div class="col-xs-12">
                            From the graph with number of families without bath, it is easy to see that the majority of families without bath have zero children, but the overall number of families are getting lower each year, which means that the living standards are improving. 
                            If we look at the graph with number of families without toilets, it is again the families without children that is the majority, but the number of overall families are lower in 2015 than in 2010, but in 2013 it was even lower than in 2015.
                            By looking at both graphs there are a lot more families that dont have bathrooms than toilets, which means that people usually chose to have a toilet from a bathroom.
                        </div>
                    </div>                
                </div>
            </div>
        </div>
        <div class="col-xs-12">
            <div id="lack-data" class="panel panel-default">
                <div class="panel-heading">Where does the houses and apartments lack toilets or baths</div>
                <div class="panel-body">
                    <div class="col-xs-2">
                        <p>
                            Seen from the graphs with percentage of houses without toilets or bath through the years, Copenhagen and Frederiksberg are 
                            the places with the highest number. It is also possible to see that both places have improved through the years, but are still more than 
                            double as high as the area in number 3. This also makes sense since both Copenhagen and Frederiksberg both have a high population within 
                            a smaller area with a lot of apartments.
                        </p>
                        <p>
                            If we look at the areas with the lowest percentage Vallensbæk, Ishøj and Ballerup they all are quite close to 0, with Vallensbæk 
                            being the lowest through the year.
                        </p>
                        <p>
                            Click on the year to get the data for the year selected.
                        </p>
                    </div>
                    <div class="col-xs-10">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#2010-families">2010</a></li>
                            <li><a data-toggle="tab" href="#2011-families">2011</a></li>
                            <li><a data-toggle="tab" href="#2012-families">2012</a></li>
                            <li><a data-toggle="tab" href="#2013-families">2013</a></li>
                            <li><a data-toggle="tab" href="#2014-families">2014</a></li>
                            <li><a data-toggle="tab" href="#2015-families">2015</a></li>
                        </ul>

                        <div class="tab-content">
                            <div id="2010-families" class="tab-pane fade in active">
                                <div class="row padding-10">
                                    <div class="col-xs-10 no-padding">
                                        <img src="img/percentage2010.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Vordingborg</li>
                                            <li>Guldborgsund</li>
                                            <li>Odsherred</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ishøj</li>
                                            <li>Ballerup</li>
                                            <li>Brøndby</li>
                                            <li>Egedal</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div id="2011-families" class="tab-pane fade">
                                <div class="row padding-10">
                                    <div class="col-xs-10 no-padding">
                                        <img src="img/percentage2011.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Guldborgsund</li>
                                            <li>Vordingborg</li>
                                            <li>Odsherred</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ishøj</li>
                                            <li>Brøndby</li>
                                            <li>Ballerup</li>
                                            <li>Egedal</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div id="2012-families" class="tab-pane fade">
                                <div class="row padding-10">
                                    <div class="col-xs-10 no-padding">
                                        <img src="img/percentage2012.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Guldborgsund</li>
                                            <li>Gentofte</li>
                                            <li>Morsø</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ishøj</li>
                                            <li>Ballerup</li>
                                            <li>Brøndby</li>
                                            <li>Egedal</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div id="2013-families" class="tab-pane fade">
                                <div class="row padding-10">
                                    <div class="col-xs-10 no-padding">
                                        <img src="img/percentage2013.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Guldborgsund</li>
                                            <li>Morsø</li>
                                            <li>Gentofte</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ishøj</li>
                                            <li>Ballerup</li>
                                            <li>Brøndby</li>
                                            <li>Greve</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div id="2014-families" class="tab-pane fade">
                                <div class="row padding-10">
                                    <div class="col-xs-10 no-padding">
                                        <img src="img/percentage2014.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Lolland</li>
                                            <li>Guldborgsund</li>
                                            <li>Morsø</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ballerup</li>
                                            <li>Ishøj</li>
                                            <li>Brøndby</li>
                                            <li>Greve</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div id="2015-families" class="tab-pane fade">
                                <div class="row padding-10">
                                    <div class="col-xs-10">
                                        <img src="img/percentage2015.jpg" data-toggle="magnify" class="img-responsive center-block">
                                    </div>
                                    <div class="col-xs-2 no-padding" style="padding-top: 50px;">
                                        <strong>5 highest</strong>
                                        <ol>
                                            <li>København</li>
                                            <li>Frederiksberg</li>
                                            <li>Guldborgsund</li>
                                            <li>Lolland</li>
                                            <li>Morsø</li>
                                        </ol>
                                        <strong>5 lowest</strong>
                                        <ol>
                                            <li>Vallensbæk</li>
                                            <li>Ishøj</li>
                                            <li>Ballerup</li>
                                            <li>Brøndby</li>
                                            <li>Greve</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
        <div class="col-xs-12">
            <div id="machine-data" class="panel panel-default">
                <div class="panel-heading">What did the machines tell us</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-10">
                            <img class="img-responsive" style="margin-top:250px;" data-toggle="magnify" src="img/denmark.jpg" alt="">
                        </div>
                        <div class="col-xs-2">
                            <p>
                                The features we have selected are: House type, Area code, Year and WcBath, 
                                this is hold up against how many children the familie have.
                                From the Decision tree and Naive Bayes Classifier, we train two models and 
                                try to predict our test set. The features made are random so that the classifiers 
                                are not trained on the same data, we run each classifier ten times. This also 
                                means that the predictions wont be the same, this is the data when 
                                we last ran it:
                            </p>
                            <p>
                                <strong>Decision tree classifier</strong>
                                <br/>
                                [106462, 101035, 101464, 105698, 106493, 107963, 105756, 101621, 105121, 100169]
                                <br/>
                                Number of mislabeled points out of a total 228284 points : 128115
                                <br/>
                                Got 45.64 % Correct
                            </p>
                            <p>
                                <strong>Naive Bayes classifier</strong>
                                <br/>
                                [109920, 108702, 109511, 109138, 110745, 103957, 109650, 110381, 109928, 98124]
                                <br/>
                                Number of mislabeled points out of a total 228284 points : 130160
                                <br/>
                                Got 47.31 % Correct
                            </p>
                            <p>
                                <strong>Guessing one every time</strong>
                                <br/>
                                [93311, 93524, 95251, 95252, 94181, 91955, 94323, 94552, 94889, 95231]
                                <br/>
                                Got 41.28 % Correct
                            </p>
                            <p>
                                This means that the Decision tree and the Naive Bayes classifiers are better 
                                than guessing the most commen value, but have still guessed less than 
                                half correct.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <!-- Include the d3 lib so we can make cool graphs -->
        <script src="js/d3.min.js"></script>
        <script src="js/jquery.easing.min.js"></script>
        <script src="js/scrolling-nav.js"></script>
        <script src="js/bootstrap-magnify.min.js"></script>

        <script type='text/javascript'>
            jQuery.noConflict();
            var $j = jQuery;
            var dod = dod || {};
            /************************
             ** chart functions
             ***********************/
            dod.Chart = function () {
                return {
                    $j: jQuery,
                    width: 970,
                    height: 850,
                    centerX: 0,
                    centerY: 0,
                    svg: {},
                    force: null,
                    gravity: null,
                    mapProjection: d3.geo.conicConformal().scale(10300).center([11, 56.3]),
                    mapFeatures: [],
                    mapPath: {},
                    mapCountour: {},
                    totalChildren: 0,
                    municipality_array: [],
                    municipality_data_array: [],
                    circle: {},
                    data_bobbles: [],
                    current_data: [],
                    nodes: [],
                    maxNodeChild: 0,
                    fillColor: d3.scale.ordinal().domain([0, 1, 2, 3, 4, 5, 6]).range(["#88CC88", "#55AA55", "#2D882D", "#116611", "#004400"]),
                    strokeColor: d3.scale.ordinal().domain([0, 1, 2, 3, 4, 5, 6]).range(["#D9F0A0", "#ABC864", "#81A035", "#5B7814", "#395000"]),
                    getFillColor: null,
                    getStrokeColor: null,
                    q: null,
                    defaultCharge: function (d) {
                        if (d.value < 0) {
                            return 0;
                        } else {
                            return -Math.pow(d.R, 2.0) / 8;
                        }
                        ;
                    },
                    data_facts: {"2013": {"total": 1881, "percentage": 0.138361624767}, "2014": {"total": 1877, "percentage": 0.13846471621}, "2015": {"total": 1843, "percentage": 0.135989268432}},
                    defaultGravity: 0.1,
                    wc_bath_types: {"1": "Toilet in dwelling & Bathroom in dwelling", "2": "Toilet in dwelling or Bathroom in dwelling", "3": "Toilet outside dwelling or Access to bathroom", "4": "Other/no toilet or No bathroom or access to bathroom"},
                    housing_types: {"1": "Detached houses/farmhouses", "2": "Terraced, linked or semi-detached houses", "3": "Multi-dwelling houses"},
                    current_year: "2013",
                    years: ["2013", "2014", "2015"],
                    charts: [{"chart": "map", "name": "Country Distribution"}, {"chart": "bobble", "name": "All Sanatories"}, {"chart": "circle", "name": "Type of Sanatory"}],
                    mapExplainTxt: "The map is showing displaying some basic data for each municipality when hovering over them. You can also zoom or drag the map to find the data of the municipality you want.\n\
                                    <br/><br/> When saying approximated, it is because the families is divinded into groups. They are as follows: <ul><li>0 Children</li><li>1 Child</li><li>2 Children</li><li>3 Children</li><li>4 Children</li><li>5 or Above Children</li></ul>",
                    maxValueForYear: function (year) {
                        var that = this;
                        return d3.max(this.municipality_array, function (data) {
                            if ("" + year === that.current_year) {
                                return data.Count;
                            }
                            return 0;
                        });
                    },
                    rScale: function (n) {
                        var that = this;
                        var scale = d3.scale.pow().exponent(.5).domain([0, that.maxValueForYear(that.current_year)]).range([3, 90]);
                        return scale(n);
                    },
                    init: function () {
                        var that = this;
                        d3.select(".progress-bar").style("width", "25em").style("min-width", "25em").html("25%");
                        d3.select('#showing-year').html("Showing data for year " + this.current_year);
                        this.svg = d3.select("#dod-canvas")
                                .append("svg:svg")
                                .attr("width", that.width)
                                .call(d3.behavior.zoom()
                                        .on("zoom", function () {
                                            that.zoomMap();
                                        }));

                        this.boundingRadius = this.rScale(this.maxValueForYear(this.current_year));
                        this.mapPath = d3.geo.path().projection(this.mapProjection);
                        this.centerX = this.width / 2;
                        this.centerY = this.height / 2;
                        this.mapCountour = this.svg
                                .append("g")
                                .attr("id", "mapCountour");
                        this.loadMunicipality();
                        this.getStrokeColor = function (d) {
                            var x = d3.scale.quantize().domain([0, that.maxNodeChild - 20000]).range([0, 1, 2, 3, 4]);
                            return this.strokeColor(x(d.approx));
                        };
                        this.getFillColor = function (d) {
                            if (d.approx === 0) {
                                return "#fff";
                            }

                            var x = d3.scale.quantize().domain([0, that.maxNodeChild - 20000]).range([0, 1, 2, 3, 4]);
                            return this.fillColor(x(d.approx));
                        };

                        d3.select("#dod-lbl-wcbath")
                                .style('top', (that.centerY - 200) + "px")
                                .style('left', 850 + "px")
                                .html(that.wc_bath_types["1"]);
                        d3.select("#dod-lbl-wcorbath")
                                .style('top', (that.centerY - 200) + "px")
                                .style('left', 120 + "px")
                                .html(that.wc_bath_types["2"]);
                        d3.select("#dod-lbl-nowcorbath")
                                .style('top', (that.centerY + 50) + "px")
                                .style('left', 700 + "px")
                                .html(that.wc_bath_types["3"]);
                        d3.select("#dod-lbl-nowcandbath")
                                .style('top', (that.centerY) + "px")
                                .style('left', 175 + "px")
                                .html(that.wc_bath_types["4"]);
                    },
                    loadMunicipality: function () {
                        var that = this;
                        dod.setupButtons().init();
                        d3.json('js/IkkeOpdelt.json', function (data) {
                            that.municipality_array = data;
                            that.loadData();
                            d3.select(".progress-bar").style("width", "50em").style("min-width", "50em").html("50%");
                        });
                    },
                    loadData: function () {
                        var that = this;
                        d3.json('js/Opdelt.json', function (data) {
                            that.municipality_data_array = data;
                            that.generateDataArray();
                            that.loadGeo();
                            d3.select(".progress-bar").style("width", "75em").style("min-width", "75em").html("75%");
                        });
                    },
                    loadGeo: function () {
                        var that = this;
                        //Load in GeoJSON data
                        d3.json("js/kommuner.geojson", function (json) {
                            that.mapFeatures = json.features;
                            that.setupMap();
                            that.setupCircles();
                            d3.select(".progress-bar").style("width", "100em").style("min-width", "100em").html("100%");
                            that.$j("#loading").hide();
                        });
                    },
                    getNameFromCode: function (code) {
                        var name = "";
                        for (var i = 0; i < this.municipality_array.length; i++) {
                            if ("" + this.municipality_array[i]['District Code'] === "" + code) {
                                name = this.municipality_array[i]['District'];
                            }
                        }

                        return name;
                    },
                    generateNodes: function () {
                        var info = [];
                        var that = this;
                        for (var i = 0; i < this.current_data.length; i++) {
                            if (this.current_data[i]['Year'] === this.current_year) {
                                var infoIndex = info.findIndex(function (element) {
                                    return (this.WcBath === element.WcBath && this.Code === element.Code);
                                }, {"Code": this.current_data[i]['District Code'], "WcBath": this.current_data[i]['WcBath']});
                                if (infoIndex === -1) {
                                    var obj = {
                                        "ID": this.current_data[i]['District Code'] + "-" + this.current_data[i]['WcBath'],
                                        "Code": this.current_data[i]['District Code'],
                                        "Name": this.getNameFromCode(this.current_data[i]['District Code']),
                                        "Count": this.current_data[i]['Count'],
                                        "Housing": this.current_data[i]['House type'],
                                        "WcBath": this.current_data[i]['WcBath'],
                                        "approx": (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']),
                                        "R": this.rScale((this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']))
                                    };
                                    info.push(obj);
                                } else {
                                    var obj = info[infoIndex];
                                    obj['Count'] += this.current_data[i]['Count'];
                                    obj['approx'] += (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']);
                                    obj['R'] = this.rScale(obj['approx']),
                                            info[infoIndex] = obj;
                                }

                                if (infoIndex !== -1) {

                                    if (this.maxNodeChild < info[infoIndex]['approx']) {
                                        this.maxNodeChild = info[infoIndex]['approx'];
                                    }
                                }
                            }
                        }
                        info.sort(function (a, b) {
                            return b['approx'] - a['approx'];
                        });

                        this.nodes = info;


                        d3.select("#dod-scaleKey").append("circle")
                                .attr('r', that.rScale(100000))
                                .attr('class', "dod-scaleKeyCircle")
                                .attr('cx', 60)
                                .attr('cy', 60);
                        d3.select("#dod-scaleKey").append("circle")
                                .attr('r', that.rScale(1000))
                                .attr('class', "dod-scaleKeyCircle")
                                .attr('cx', 60)
                                .attr('cy', 80);
                        d3.select("#dod-scaleKey").append("circle")
                                .attr('r', that.rScale(100))
                                .attr('class', "dod-scaleKeyCircle")
                                .attr('cx', 60)
                                .attr('cy', 85);
                    },
                    updateCircles: function () {
                        var that = this;
                        this.circle = this.svg.selectAll("circle")
                                .data(this.nodes, function (d) {
                                    return d.ID;
                                });

                        this.circle.attr("r", function (d) {
                            return d.R;
                        })
                                .style("fill", function (d) {
                                    return that.getFillColor(d);
                                })
                                .style("stroke", function (d) {
                                    return that.getStrokeColor(d);
                                })
                                .style("stroke-width", 1)
                                .attr('id', function (d) {
                                    return 'dod-circle-' + d.ID;
                                });

                        if (this.force !== null) {
                            this.start();
                            //this.totalLayout();
                        }
                    },
                    setupCircles: function () {
                        var that = this;
                        this.circle = this.svg.selectAll("circle")
                                .data(this.nodes, function (d) {
                                    return d.ID;
                                });

                        this.circle.enter().append("svg:circle")
                                .attr("r", function (d) {
                                    return d.R;
                                })
                                .style("fill", function (d) {
                                    return that.getFillColor(d);
                                })
                                .style("stroke", function (d) {
                                    return that.getStrokeColor(d);
                                })
                                .style("stroke-width", 1)
                                .attr('id', function (d) {
                                    return 'dod-circle-' + d.ID;
                                })
                                .attr("visibility", "hidden")
                                .on("mouseover", function (d) {
                                    var el = d3.select(this);
                                    var xpos = el.attr('cx');
                                    var ypos = (el.attr('cy') - d.R + 15);

                                    el.style("stroke", "#000")
                                            .style("stroke-width", 3);

                                    d3.select("#dod-graph-tooltip")
                                            .style('top', ypos + "px")
                                            .style('left', xpos + "px")
                                            .style('display', 'block');

                                    d3.select(".dod-graph-name").html(d.Name);
                                    d3.select("#dod-graph-house").html(that.housing_types[d.Housing]);
                                    d3.select("#dod-graph-wcbath").html(that.wc_bath_types[d.WcBath]);
                                    d3.select("#dod-graph-children").html(d.approx);
                                })
                                .on("mouseout", function () {
                                    d3.select(this)
                                            .style("stroke-width", 1)
                                            .style("stroke", function (d) {
                                                return that.getFillColor(d);
                                            });
                                    d3.select("#dod-graph-tooltip")
                                            .style('display', 'none');
                                });
                        this.start();
                    },
                    setupMap: function () {
                        var that = this;
                        //setup the totals facts
                        this.$j("#dod-map-explanation-txt").html(this.mapExplainTxt);
                        this.generateMapTotals();
                        //Bind data and create one path per GeoJSON feature
                        this.mapCountour.selectAll("path")
                                .data(that.mapFeatures)
                                .enter()
                                .append("path")
                                .attr("d", that.mapPath)
                                .attr("stroke", "black")
                                .style("fill", "steelblue")
                                .on('mouseover', function (d) {
                                    var el = d3.select(this);
                                    var bBox = that.tooltipPosition(el);
                                    var xpos = Number(bBox[0]);
                                    var ypos = (bBox[1] - 10);
                                    var data = that.getInfo(d.properties.KOMKODE);
                                    el.style("stroke", "#000")
                                            .style("stroke-width", 3);
                                    d3.select("#dod-map-tooltip")
                                            .style('display', 'block');
                                    d3.select(".dod-name")
                                            .html(data['District'] + " " + data['District Code']);
                                    d3.select("#dod-children")
                                            .html(that.getChildrenForCode(d.properties.KOMKODE).toLocaleString('en-US'));
                                })
                                .on('mouseout', function () {
                                    d3.select(this)
                                            .style("stroke-width", 1);
                                    d3.select("#dod-map-tooltip")
                                            .style('display', 'none');
                                });
                        this.mapCountour.active = true;
                    },
                    generateMapTotals: function () {
                        var totalData = this.getInfoData();
                        var children = 0;
                        var childrenByHouseType = {};
                        var div = this.$j("#dod-map-facts");
                        for (var i = 0; i < totalData.length; i++) {

                            if (childrenByHouseType.hasOwnProperty(totalData[i]['Housing'])) {
                                childrenByHouseType[totalData[i]['Housing']] += totalData[i]['approx'];
                            } else {
                                childrenByHouseType[totalData[i]['Housing']] = totalData[i]['approx'];
                            }
                            children += totalData[i]['approx'];
                        }

                        this.totalChildren = children;
                        div.html('<h4>The approx. number of children per house type</h4>'
                                + '<h5>' + this.housing_types[1] + '</h5>'
                                + childrenByHouseType[1].toLocaleString('en-US')
                                + '<h5>' + this.housing_types[2] + '</h5>'
                                + childrenByHouseType[2].toLocaleString('en-US')
                                + '<h5>' + this.housing_types[3] + '</h5>'
                                + childrenByHouseType[3].toLocaleString('en-US')
                                + '<h5>Total</h5>'
                                + children.toLocaleString('en-US')
                                );
                    },
                    zoomMap: function () {
                        this.mapCountour.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                    },
                    tooltipPosition: function (element) {
                        var bbox = element.node().getBBox();
                        return [bbox.x + bbox.width / 2, bbox.y - 10 + bbox.height / 2];
                    },
                    generateDataArray: function () {
                        var that = this;
                        this.current_data = [];
                        for (var i = 0; i < this.municipality_data_array.length; i++) {
                            if ("" + this.municipality_data_array[i]['Year'] === "" + this.current_year) {
                                this.current_data.push(this.municipality_data_array[i]);
                            }
                        }

                        this.generateNodes();
                        this.generateMapTotals();
                        this.updateCircles();

                        d3.select("#dod-nowcbath circle").remove();
                        d3.select("#dod-nowcbath").append("circle")
                                .attr('r', that.rScale(that.data_facts[that.current_year]['total']))
                                .attr('class', "dod-nowcbath")
                                .attr('cx', 125)
                                .attr('cy', 125);
                        d3.select("#dod-nowcbath-total").html(that.data_facts[that.current_year]['total']);
                        d3.select("#dod-percent-children").html(that.data_facts[that.current_year]['percentage'].toFixed(3));
                    },
                    getChildrenForCode: function (code) {
                        var children = 0;
                        for (var i = 0; i < this.current_data.length; i++) {
                            if (this.current_data[i]['Year'] === this.current_year && "" + this.current_data[i]['District Code'] === "" + code) {
                                children += (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']);
                            }
                        }
                        return children;
                    },
                    getInfoData: function () {
                        var info = [];
                        for (var i = 0; i < this.current_data.length; i++) {
                            if (this.current_data[i]['Year'] === this.current_year) {
                                var infoIndex = info.findIndex(function (element) {
                                    return (this.WcBath === element.WcBath && this.Housing === element.Housing);
                                }, {"WcBath": this.current_data[i]['WcBath'], "Housing": this.current_data[i]['House type']});
                                if (infoIndex === -1) {
                                    var obj = {
                                        "Count": this.current_data[i]['Count'],
                                        "Housing": this.current_data[i]['House type'],
                                        "WcBath": this.current_data[i]['WcBath'],
                                        "approx": (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count'])
                                    };
                                    info.push(obj);
                                } else {
                                    var obj = info[infoIndex];
                                    obj['Count'] += this.current_data[i]['Count'];
                                    obj['approx'] += (this.current_data[i]['Children'] === 0 ? 0 : this.current_data[i]['Children'] * this.current_data[i]['Count']);
                                    info[infoIndex] = obj;
                                }
                            }
                        }

                        return info;
                    },
                    getInfo: function (code) {
                        var data = [];
                        for (var i = 0; i < this.municipality_array.length; i++) {
                            if ("" + this.municipality_array[i]['District Code'] === "" + code && "" + this.current_year === "" + this.municipality_array[i]['Year']) {
                                data = this.municipality_array[i];
                                break;
                            }
                        }

                        return data;
                    },
                    /**
                     * Layouts
                     */
                    start: function () {
                        this.force = d3.layout.force()
                                .nodes(this.nodes)
                                .size([this.width, this.height]);
                    },
                    totalLayout: function () {
                        var that = this;
                        this.force
                                .gravity(-0.01)
                                .charge(that.defaultCharge)
                                .friction(0.9)
                                .on("tick", function (e) {
                                    that.circle
                                            .each(that.sortTotals(e.alpha))
                                            .each(that.buoyancy(e.alpha))
                                            .attr("cx", function (d) {
                                                return d.x;
                                            })
                                            .attr("cy", function (d) {
                                                return d.y;
                                            });
                                })
                                .start();
                    },
                    sanatoryLayout: function () {
                        var that = this;
                        this.force
                                .gravity(0)
                                .friction(0.9)
                                .charge(that.defaultCharge)
                                .on("tick", function (e) {
                                    that.circle
                                            .each(that.sortSanatory(e.alpha))
                                            .each(that.buoyancy(e.alpha))
                                            .attr("cx", function (d) {
                                                return d.x;
                                            })
                                            .attr("cy", function (d) {
                                                return d.y;
                                            });
                                })
                                .start();
                    },
                    /**
                     * Sortings
                     */
                    sortTotals: function (alpha) {
                        var that = this;
                        return function (d) {
                            d.y = d.y + (that.centerY - 150 - d.y) * (that.defaultGravity + 0.02) * alpha;
                            d.x = d.x + (that.centerX - d.x) * (that.defaultGravity + 0.02) * alpha;
                        };
                    },
                    sortSanatory: function (alpha) {
                        var that = this;
                        return function (d) {
                            var targetY = that.centerY;
                            var targetX = 0;

                            if (+d.WcBath === 1) {
                                targetX = 600;
                                targetY = targetY - 200;
                            } else if (+d.WcBath === 2) {
                                targetX = 450;
                                targetY = targetY - 200;
                            } else if (+d.WcBath === 3) {
                                targetX = 600;
                                targetY = targetY - 100;
                            } else if (+d.WcBath === 4) {
                                targetX = 450;
                                targetY = targetY - 100;
                            }

                            d.y = d.y + (targetY - d.y) * (that.defaultGravity) * alpha * 1.1;
                            d.x = d.x + (targetX - d.x) * (that.defaultGravity) * alpha * 1.1;
                        };
                    },
                    buoyancy: function (alpha) {
                        var that = this;
                        return function (d) {
                            d.y = d.y + (that.centerY - d.y) * (that.defaultGravity) * alpha * alpha * alpha * 100;
                        };
                    }
                };
            };

            /************************
             ** button functions
             ***********************/

            dod.setupButtons = function () {
                return {
                    $j: jQuery,
                    current_activated: {},
                    init: function () {
                        var that = this;
                        for (var i = 0; i < dod.c.years.length; i++) {
                            var year = d3.select("#years")
                                    .insert('button')
                                    .attr('type', 'button')
                                    .attr('class', 'btn-year btn btn-default')
                                    .attr('data-year', dod.c.years[i])
                                    .html(dod.c.years[i])
                                    .on('click', function () {
                                        var year = d3.select(this).attr('data-year');
                                        var activeClass = "active";
                                        var alreadyIsActive = d3.select(this).classed(activeClass);

                                        // set active year button
                                        d3.selectAll(".btn-year")
                                                .classed(activeClass, false);
                                        d3.select(this).classed(activeClass, !alreadyIsActive);
                                        dod.c.current_year = year;
                                        dod.c.generateDataArray();
                                        that.current_activated();
                                        d3.select('#showing-year').html("Showing data for year " + year);
                                    });

                            if (i === 0) {
                                year.classed('active', true);
                            }
                        }

                        d3.select("#charts")
                                .insert('button')
                                .attr('type', 'button')
                                .attr('class', 'btn-chart btn btn-default active')
                                .attr('data-chart', dod.c.charts[0].chart)
                                .html(dod.c.charts[0].name)
                                .on('click', function () {
                                    var year = d3.select(this).attr('data-chart');
                                    var activeClass = "active";
                                    var alreadyIsActive = d3.select(this).classed(activeClass);

                                    // set active year button
                                    d3.selectAll(".btn-chart")
                                            .classed(activeClass, false);
                                    d3.select(this).classed(activeClass, !alreadyIsActive);

                                    that.hideCircles();
                                    that.showMap();
                                    that.hideSplit();
                                    that.hideTotal();
                                    that.current_activated = function () {
                                    };
                                });
                        d3.select("#charts")
                                .insert('button')
                                .attr('type', 'button')
                                .attr('class', 'btn-chart btn btn-default')
                                .attr('data-chart', dod.c.charts[1].chart)
                                .html(dod.c.charts[1].name)
                                .on('click', function () {
                                    var year = d3.select(this).attr('data-chart');
                                    var activeClass = "active";
                                    var alreadyIsActive = d3.select(this).classed(activeClass);
                                    // set active year button
                                    d3.selectAll(".btn-chart")
                                            .classed(activeClass, false);
                                    d3.select(this).classed(activeClass, !alreadyIsActive);
                                    that.showCircles();
                                    that.hideMap();
                                    that.hideSplit();
                                    that.showTotal();

                                    if (dod.c.nodes.length === 0) {
                                        dod.c.generateNodes();
                                    }

                                    dod.c.updateCircles();
                                    dod.c.totalLayout();

                                    that.current_activated = function () {
                                        dod.c.start();
                                        dod.c.totalLayout();
                                    };
                                });

                        d3.select("#charts")
                                .insert('button')
                                .attr('type', 'button')
                                .attr('class', 'btn-chart btn btn-default')
                                .attr('data-chart', dod.c.charts[2].chart)
                                .html(dod.c.charts[2].name)
                                .on('click', function () {
                                    var year = d3.select(this).attr('data-chart');
                                    var activeClass = "active";
                                    var alreadyIsActive = d3.select(this).classed(activeClass);
                                    // set active year button
                                    d3.selectAll(".btn-chart")
                                            .classed(activeClass, false);
                                    d3.select(this).classed(activeClass, !alreadyIsActive);
                                    that.showCircles();
                                    that.hideMap();
                                    that.hideTotal();
                                    that.showSplit();

                                    if (dod.c.nodes.length === 0) {
                                        dod.c.generateNodes();
                                    }
                                    dod.c.updateCircles();
                                    dod.c.sanatoryLayout();


                                    that.current_activated = function () {
                                        dod.c.start();
                                        dod.c.sanatoryLayout();
                                    };
                                });

                        that.hideSplit();
                        that.hideTotal();

                    },
                    hideMap: function () {
                        dod.c.mapCountour.transition().style("opacity", 0);
                        this.$j("#dod-map-overlay").hide();
                        this.$j("#dod-map-tooltip").css("opacity", 0).hide();
                    },
                    showMap: function () {
                        dod.c.mapCountour.transition().style("opacity", 1);
                        this.$j("#dod-map-overlay").show();
                        this.$j("#dod-map-tooltip").css("opacity", 1);
                    },
                    showSplit: function () {
                        this.$j("#dod-split-overlay").show();
                    },
                    hideSplit: function () {
                        this.$j("#dod-split-overlay").hide();
                    },
                    showTotal: function () {
                        this.$j("#dod-total-overlay").show();
                    },
                    hideTotal: function () {
                        this.$j("#dod-total-overlay").hide();
                    },
                    hideCircles: function () {
                        d3.selectAll("circle").transition().attr("visibility", "hidden");
                    },
                    showCircles: function () {
                        dod.c.updateCircles();
                        d3.selectAll("circle").transition().attr("visibility", "visible");
                    }
                };
            };
            dod.ready = function () {
                dod.c = new dod.Chart();
                dod.c.init();
            };
            if (!!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect) {
                $j(document).ready($j.proxy(dod.ready, this));
            } else {
                $j("#dod-mapFrame").hide();
            }
        </script>
    </body>
</html>